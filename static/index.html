<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Remote Task Executor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Executor">
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-monokai.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            background: #f0f2f5;
            color: #333;
            padding-bottom: 50px;
            overflow-x: hidden;
        }

        header {
            background: #1a1a1a;
            color: #fff;
            padding: 15px;
            text-align: center;
            font-weight: bold;
        }

        nav {
            display: flex;
            background: #333;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

            nav button {
                flex: 1;
                color: #bbb;
                background: none;
                border: none;
                padding: 14px;
                cursor: pointer;
                transition: 0.3s;
            }

                nav button.active {
                    color: #fff;
                    background: #444;
                    border-bottom: 3px solid #007bff;
                }

        section {
            display: none;
            padding: 20px;
            max-width: 98%;
            margin: 0 auto;
            box-sizing: border-box;
        }

            section.active {
                display: flex;
                flex-direction: column;
            }

        .card {
            background: #fff;
            padding: 18px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 15px;
        }

            .card h3 {
                margin-top: 0;
                font-size: 16px;
                color: #555;
                border-left: 4px solid #007bff;
                padding-left: 10px;
            }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
        }


        .btn {
            background: #1a1a1a;
            color: #fff;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-sizing: border-box;
            width: 100%;
        }

            .btn:hover {
                background: #333;
            }


        .btn-primary {
            background: #007bff !important;
        }

            .btn-primary:hover {
                background: #0056b3 !important;
            }


        .btn-small {
            width: auto;
            padding: 6px 15px;
            font-size: 12px;
            background: #666;
        }

        .code-box-fixed {
            height: calc(85vh - 170px);
            background: #272822;
            border-radius: 0 0 8px 8px;
            overflow: auto;
            position: relative;
        }

        #cmdResp, #filePreview {
            margin: 0 !important;
            padding: 20px !important;
            display: block;
            box-sizing: border-box;
            height: 100%;
        }


        .code-container {
            background: #1e1e1e !important;
            border-radius: 6px;
            overflow: auto !important;
            position: relative;
        }

        #cmdResp, #filePreview {
            margin: 0 !important;
            padding: 20px 10px !important;
            color: #f8f8f2 !important;
            font-family: 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.5;
            white-space: pre !important;
            word-wrap: normal !important;
            display: block;
            background: transparent !important;
            min-width: 100%;
            box-sizing: border-box;
            z-index: 2;
        }


        pre[class*="language-"] {
            margin: 0 !important;
            padding: 0 !important;
            background: transparent !important;
            overflow: visible !important;
        }


        #files .flex-box {
            display: flex;
            height: 80vh;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #eee;
            overflow: hidden;
        }

        .tree-side {
            width: 280px;
            flex-shrink: 0;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
            margin-right: 2px;
        }

        .preview-main {
            flex-grow: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            background: #272822;
        }

        .preview-header {
            background: #ebebeb;
            padding: 10px 15px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        #filePreviewContainer {
            flex-grow: 1;
            overflow: auto;
        }


        @media (min-width: 1024px) {
            #cmd .card-container {
                display: flex;
                gap: 20px;
                align-items: flex-start;
            }

            #cmd .card:first-child {
                width: 380px;
                flex-shrink: 0;
            }

            #cmd .card:last-child {
                flex-grow: 1;
                min-width: 0;
            }

            #cmd .code-container {
                height: calc(85vh - 120px);
            }
        }

        @media (max-width: 768px) {

            #cmd .card-container,
            #files .card-container,
            #files .flex-box {
                display: flex !important;
                flex-direction: column !important;
                gap: 10px !important;
            }


            #cmd .card,
            .tree-side,
            #files .card {
                width: 100% !important;
                max-width: 100% !important;
                flex-shrink: 1 !important;
            }


            #dirTree {
                height: 30vh !important;
            }


            .code-box-fixed {
                height: 50vh !important;
            }


            section {
                padding: 10px !important;
            }


            nav button {
                padding: 10px 5px !important;
                font-size: 14px;
            }
        }


        .card {
            box-sizing: border-box;
            max-width: 100%;
        }




        #dirTree {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            font-size: 14px;
        }

        .tree-branch {
            margin-left: 18px;
            border-left: 1px solid #eee;
        }

        .tree-item {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            cursor: pointer;
            border-radius: 4px;
        }

            .tree-item:hover {
                background: #f0f0f0;
            }

        .icon {
            margin-right: 8px;
            width: 16px;
            text-align: center;
        }


        .token.comment {
            color: #75715e !important;
        }

        .token.keyword {
            color: #66d9ef !important;
        }

        .token.string {
            color: #e6db74 !important;
        }

        .token.function {
            color: #a6e22e !important;
        }


        .code-box-fixed pre {
            display: flex !important;
            flex-direction: column;
        }

        pre.line-numbers {
            padding-left: 3.8em !important;
            position: relative;
            background: #272822 !important;
        }

        .line-numbers .line-numbers-rows {
            position: absolute;
            pointer-events: none;
            top: 0;
            left: -3.8em !important;
            width: 3em !important;
            padding: 20px 0 !important;
            border-right: 1px solid #444 !important;
            background: #2d2d2d !important;
        }
    </style>
    <style>
        @media (max-width: 1024px) {
            #cmd .card-container, #files .card-container, #files .flex-box {
                flex-direction: column !important;
            }

            .tree-side, #cmd .card, #files .card {
                width: 100% !important;
                max-width: 100% !important;
            }

            nav button {
                font-size: 13px;
                padding: 10px 2px;
            }
        }
    </style>
</head>
<body>

    <header>Remote Task Executor</header>

    <nav>
        <button id="nav-login" onclick="showTab('login')">‚öôÔ∏è Settings</button>
        <button id="nav-cmd" onclick="showTab('cmd')">üöÄ Dispatcher</button>
        <button id="nav-files" onclick="showTab('files')">üìÅ Explorer</button>
    </nav>

    <section id="login">
        <div class="card" style="max-width: 500px; margin: 40px auto;">
            <h3>Connection Config</h3>
            <input id="apiAddr" placeholder="Server Address (e.g., http://1.2.3.4:8000)">
            <input type="password" id="apiToken" placeholder="Access Token">
            <button class="btn btn-primary" onclick="saveConfig()">Save & Connect</button>
        </div>
    </section>

    <section id="cmd">
        <div class="card-container" style="display: flex; gap: 20px; align-items: flex-start; width: 100%;">
            <div class="card" style="width: 380px; flex-shrink: 0;">
                <h3>Dispatch Command</h3>
                <select id="actionType" onchange="updateUI()">
                    <option value="execute" selected>üöÄ Run Python Code</option>
                    <option value="install_pip">üì¶ Pip: Install Package</option>
                    <option value="uninstall_pip">‚ôªÔ∏è Pip: Uninstall Package</option>
                    <option value="read_file">üìñ Read Remote File</option>
                    <option value="create_file">‚ûï Create New File</option>
                    <option value="update_file">üìù Edit / Patch Content</option>
                    <option value="delete_file">üóëÔ∏è Delete File</option>
                </select>
                <div id="dynamicInputs"></div>
                <button class="btn btn-primary" onclick="submitTask()">Execute Task</button>
            </div>

            <div class="card" style="flex-grow: 1; min-width: 0; padding: 0; display: flex; flex-direction: column;">
                <div style="padding: 18px 18px 0 18px;">
                    <h3>Live Output</h3>
                </div>
                <div style="height: 45px; display: flex; align-items: center; padding: 0 18px;">
                    <span style="font-size: 12px; color: #bbb;">System Terminal Response</span>
                </div>
                <div class="code-box-fixed">
                    <pre style="margin: 0;"><code id="cmdResp">Awaiting task...</code></pre>
                </div>
            </div>
        </div>
    </section>

    <section id="files">
        <div class="card-container" style="display: flex; gap: 20px; align-items: flex-start; width: 100%;">
            <div class="card" style="width: 380px; flex-shrink: 0;">
                <h3>File Tree</h3>
                <div style="margin-bottom: 12px;">
                    <button class="btn btn-primary" onclick="loadTree()">üîÑ Refresh Directory</button>
                </div>
                <div id="dirTree" style="height: calc(85vh - 170px); overflow-y: auto; border: 1px solid #eee; border-radius: 4px; padding: 10px; background: #fafafa;">
                </div>
            </div>

            <div class="card" style="flex-grow: 1; min-width: 0; padding: 0; display: flex; flex-direction: column;">
                <div style="padding: 18px 18px 0 18px;">
                    <h3>Viewer: <span id="fileNameDisplay" style="font-size: 13px; color: #999; font-weight: normal; margin-left: 10px;">No file selected</span></h3>
                </div>
                <div style="height: 45px; display: flex; align-items: center; justify-content: flex-end; padding: 0 18px; background: #f8f9fa; border-top: 1px solid #eee; border-bottom: 1px solid #eee;">
                    <button class="btn btn-small" style="background:#28a745; margin-right:5px;" onclick="runCurrentFile()">‚ñ∂Ô∏è Run Script</button>
                    <button class="btn btn-small" style="background:#007bff; margin-right:5px;" onclick="openEditModal()">üìù Quick Edit</button>
                    <button class="btn btn-small" style="background:#007bff;" onclick="copyContent()">üìã Copy Content</button>
                </div>
                <div class="code-box-fixed">
                    <pre style="margin: 0;"><code id="filePreview" class="language-none">Select a file to preview content...</code></pre>
                </div>
            </div>
        </div>
    </section>

    <script>
        let API_URL, TOKEN;
        /**
         * Language Mapping for Syntax Highlighting (Prism.js/Highlight.js)
         * Maps file extensions to their respective language identifiers.
         */
        const langMap = {
            // Scripts & Programming
            'py': 'python', 'cs': 'csharp', 'js': 'javascript', 'ts': 'typescript',
            'sh': 'bash', 'cmd': 'batch', 'bat': 'batch', 'vbs': 'visualbasic', 'ps1': 'powershell',

            // Styles & Frontend
            'html': 'markup', 'xml': 'markup', 'css': 'css', 'scss': 'scss', 'less': 'less',

            // Data & Protocols
            'json': 'json', 'yaml': 'yaml', 'yml': 'yaml', 'md': 'markdown', 'http': 'http',

            // Database
            'sql': 'sql', 'plsql': 'plsql',

            // Configuration Files
            'ini': 'ini', 'inf': 'ini', 'conf': 'ini', 'cfg': 'ini', 'properties': 'properties'
        };

        if (window.Prism && Prism.plugins.autoloader) {
            Prism.plugins.autoloader.languages_path = 'https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/';
        }

        function showTab(tabId) {
            document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            document.getElementById('nav-' + tabId).classList.add('active');
        }

        function saveConfig() {
            API_URL = document.getElementById('apiAddr').value.trim().replace(/\/$/, "");
            TOKEN = document.getElementById('apiToken').value.trim();
            localStorage.setItem('py_api', API_URL);
            localStorage.setItem('py_token', TOKEN);
            showTab('cmd');
        }

        window.onload = () => {
            API_URL = localStorage.getItem('py_api');
            TOKEN = localStorage.getItem('py_token');
            if (API_URL) document.getElementById('apiAddr').value = API_URL;
            if (TOKEN) document.getElementById('apiToken').value = TOKEN;
            API_URL && TOKEN ? showTab('cmd') : showTab('login');
            updateUI();
        };
        /**
         * Polling function to wait for the execution result from the server.
         * Retries every 1 second for up to 300 seconds.
         */
        async function poll(taskFilename) {
            for (let i = 0; i < 300; i++) {
                await new Promise(r => setTimeout(r, 1000));
                try {
                    const res = await fetch(`${API_URL}/read_file?type=result&filename=${taskFilename}`, {
                        headers: { "Authorization": "Bearer " + TOKEN }
                    });
                    if (res.ok) {
                        const data = await res.json();
                        if (data.success && data.content) {
                            const obj = jsyaml.load(data.content);
                            fetch(`${API_URL}/delete_file`, {
                                method: "POST",
                                headers: { "Authorization": "Bearer " + TOKEN, "Content-Type": "application/json" },
                                body: JSON.stringify({ type: "result", filename: taskFilename })
                            });
                            return obj;
                        }
                    }
                } catch (e) { }
            }
            throw new Error("Execution timeout: No response from executor within 300s.");
        }
        /**
         * Task Submission Logic
         * Handles payload construction, server dispatch, and polling for results.
         */
        async function submitTask() {
            const action = document.getElementById('actionType').value;
            const tid = "task_" + Date.now();
            const fname = tid + ".yaml";
            let payload = { action, id: tid };

            const path = document.getElementById('f_path')?.value;
            const pkg = document.getElementById('f_pkg')?.value;
            const cont = document.getElementById('f_content')?.value;
            const start = document.getElementById('f_start')?.value;
            const end = document.getElementById('f_end')?.value;

            if (path) payload.file = path;
            if (pkg) payload.package = pkg;
            if (cont !== undefined) payload.content = cont;
            // --- Core Logic: Handle Update Range (Patching vs Appending) ---
            if (action === "update_file") {
                if (start && end) {
                    payload.range = `${start}-${end}`; // Modify specific line range
                } else if (start) {
                    payload.range = `${start}-${start}`; // Single line modification
                } else {
                    payload.range = "append"; // Default to append mode if range is empty
                }
            }

            const outBox = document.getElementById('cmdResp');
            outBox.innerText = `>> Executing...`;
            outBox.className = "";

            try {
                // Dispatch command to the relay server
                await fetch(`${API_URL}/save_file`, {
                    method: "POST",
                    headers: { "Authorization": "Bearer " + TOKEN, "Content-Type": "application/json" },
                    body: JSON.stringify({ type: "command", filename: fname, content: JSON.stringify(payload) })
                });
                // Start polling for the executor's result
                const result = await poll(fname);
                // Display execution output (stdout/stderr or custom messages)
                outBox.textContent = (result.stdout || "") + (result.stderr || "") + (result.content || result.message || "");
                outBox.style.color = result.success ? "#f8f8f2" : "#ff5555";

                if (action === "read_file" && path && result.success) {
                    const ext = path.split('.').pop().toLowerCase();
                    // Re-apply syntax highlighting if a file was read successfully
                    applyHighlight(outBox, path);
                }
                else if (!result.success) {
                    // Display specific error message if task failed
                    outBox.textContent = result.error;
                }
            } catch (e) { outBox.innerText = "Error: " + e.message; }
        }
        /**
         * Dynamic UI Generator
         * Re-renders input fields based on the selected action type.
         */
        function updateUI() {
            const type = document.getElementById('actionType').value;
            let html = "";

            // 1. Pip Operation Logic
            if (type.includes("pip")) {
                html = '<input id="f_pkg" placeholder="Package name (e.g., requests)">';
            }
            // 2. File Operation Logic
            else if (type.includes("file")) {
                html = '<input id="f_path" placeholder="Relative path (e.g., ./test.py)">';

                if (type === "create_file" || type === "update_file") {
                    // Add range inputs for file editing/patching
                    if (type === "update_file") {
                        html += `
                                        <div style="display:flex;gap:10px;">
                                            <input id="f_start" placeholder="Start line (Leave empty to append)">
                                            <input id="f_end" placeholder="End line (Optional)">
                                        </div>`;
                    }
                    // Disable spellcheck to prevent red underlines in code editor
                    html += '<textarea id="f_content" rows="10" placeholder="Enter file content here..." spellcheck="false"></textarea>';
                }
            }
            // 3. Execution Logic
            else if (type === "execute") {
                html = '<input id="f_path" placeholder="Relative path (e.g., ./test.py)">';
            }

            document.getElementById('dynamicInputs').innerHTML = html;
        }
        /**
         * File Explorer Logic
         * Requests the remote directory structure and triggers the tree renderer.
         */
        async function loadTree() {
            const tid = "task_" + Date.now();
            const fname = tid + ".yaml";
            // UI Feedback: Set loading state
            document.getElementById('dirTree').innerText = "Loading...";
            try {
                // Dispatch 'list_executor_dir' command to the relay server
                await fetch(`${API_URL}/save_file`, {
                    method: "POST",
                    headers: { "Authorization": "Bearer " + TOKEN, "Content-Type": "application/json" },
                    body: JSON.stringify({ type: "command", filename: fname, content: JSON.stringify({ action: "list_executor_dir" }) })
                });
                // Wait for the executor to return the file list
                const res = await poll(fname);
                // Render the received file list into a tree structure
                renderTree(res.files);
            } catch (e) {
                // Error handling for network or execution failures
                alert("Failed to load directory structure.");
            }
        }
        /**
         * File Tree Renderer
         * Converts a flat array of file paths into a hierarchical interactive UI.
         */
        function renderTree(files) {
            const container = document.getElementById('dirTree');
            container.innerHTML = "";
            const root = {};
            // 1. Build nested object structure from flat path strings
            files.forEach(f => {
                let curr = root;
                // Normalize path separators and split into components
                f.replace(/\\/g, '/').split('/').filter(p => p.trim()).forEach((p, i, arr) => {
                    if (!curr[p]) curr[p] = (i === arr.length - 1) ? null : {};
                    curr = curr[p];
                });
            });

            /**
             * Recursive builder for tree elements
             * Sorts: Directories first, then files alphabetically.
             */
            const build = (obj, parent, path) => {
                Object.keys(obj).sort((a, b) =>
                    // Sort logic: Folders before Files, then Alphabetical
                    (obj[a] === null) - (obj[b] === null) || a.localeCompare(b)
                ).forEach(key => {
                    const fullPath = path ? path + "/" + key : key;
                    const item = document.createElement('div');
                    item.className = "tree-item";
                    // Set icon based on type (File vs Folder)
                    item.innerHTML = `<span class="icon">${obj[key] === null ? 'üìÑ' : 'üìÅ'}</span><span>${key}</span>`;
                    if (obj[key] === null) {
                        // File click handler: triggers remote read
                        item.onclick = () => readFile(fullPath);
                        parent.appendChild(item);
                    } else {
                        // Folder click handler: toggles branch visibility
                        const wrap = document.createElement('div');
                        wrap.className = "tree-branch"; wrap.style.display = "none";
                        item.onclick = () => {
                            const isH = wrap.style.display === "none";
                            wrap.style.display = isH ? "block" : "none";
                        };
                        // Recursively build child nodes
                        build(obj[key], wrap, fullPath);
                        parent.appendChild(item);
                        parent.appendChild(wrap);
                    }
                });
            };
            // Initialize rendering from the root
            build(root, container, "");
        }
        /**
         * Remote File Reader
         * Requests the content of a specific file from the executor and updates the viewer.
         */
        async function readFile(path) {
            const area = document.getElementById('filePreview');
            document.getElementById('fileNameDisplay').innerText = "üìÑ " + path;
            // UI Feedback: Set initial loading state
            area.textContent = "Reading...";
            try {
                const tid = "task_" + Date.now();
                const fname = tid + ".yaml";
                // Dispatch 'read_file' command to the relay server
                await fetch(`${API_URL}/save_file`, {
                    method: "POST",
                    headers: { "Authorization": "Bearer " + TOKEN, "Content-Type": "application/json" },
                    body: JSON.stringify({ type: "command", filename: fname, content: JSON.stringify({ action: "read_file", file: path }) })
                });
                // Poll for the file content result
                const res = await poll(fname);
                if (res.success) {
                    // Update viewer with file content and trigger syntax highlighting
                    area.textContent = res.content;
                    applyHighlight(area, path);
                }
                else if (!res.success) {
                    // Display error returned by the executor (e.g., file not found)
                    area.textContent = res.error;
                }
            } catch (e) {
                // Handle network or unexpected runtime errors
                area.textContent = "Read Error:" + e.message;
            }
        }

        /**
         * Copy Content Logic
         * Extracts text from the viewer and copies it to the clipboard.
         * Specifically handles Prism.js line numbers and insecure contexts (IP addresses).
         */
        function copyContent() {
            const area = document.getElementById('filePreview');
            const temp = area.cloneNode(true);
            // Remove Prism.js line numbers to avoid including them in the clipboard
            const rows = temp.querySelector('.line-numbers-rows');
            if (rows) rows.remove();
            const text = temp.textContent;

            // Prioritize Modern Clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    alertFeedback();
                }).catch(() => {
                    // Fallback if the API fails or permissions are denied
                    fallbackCopy(text);
                });
            } else {
                // Fallback for non-HTTPS or IP-based environments where Clipboard API is restricted
                fallbackCopy(text);
            }
        }

        /**
         * Fallback Copy Method
         * Uses a temporary textarea to support legacy browsers or insecure (HTTP/IP) contexts.
         */
        function fallbackCopy(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;

            // Ensure the textarea is off-screen but still part of the DOM
            document.body.appendChild(textArea);
            textArea.select();
            try {
                // execCommand is deprecated but remains the only way to copy in insecure contexts
                document.execCommand('copy');
                alertFeedback();
            } catch (err) {
                // User-facing feedback if the browser blocks the copy command
                alert("Copy failed. Please select the text and copy manually.");
            }
            document.body.removeChild(textArea);
        }

        /**
         * Visual Feedback for Copy Action
         * Temporarily updates the button text to confirm a successful copy.
         */
        function alertFeedback() {
            // Select the button to provide visual confirmation
            const btn = document.querySelector('.btn-small');
            if (!btn) return; // Safety check
            const oldText = btn.innerText;
            btn.innerText = "‚úÖ Copied!";
            // Revert to original text after 2 seconds
            setTimeout(() => btn.innerText = oldText, 2000);
        }

        /**
         * Syntax Highlighting Treament
         * Applies the correct language class and triggers Prism.js.
         * Includes a layout patch for line-numbers alignment.
         */
        function applyHighlight(element, filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const lang = langMap[ext] || 'none';
            const pre = element.parentElement;
            // Apply Prism.js standard language class
            element.className = `language-${lang}`;

            if (pre && pre.tagName === 'PRE') {
                pre.className = `line-numbers language-${lang}`;
            }

            if (window.Prism) {
                Prism.highlightElement(element);

                /**
                 * Post-rendering alignment patch
                 * Ensures line numbers are correctly positioned using absolute coordinates.
                 */
                setTimeout(() => {
                    const rows = element.querySelector('.line-numbers-rows') || pre.querySelector('.line-numbers-rows');
                    if (rows) {
                        // Force layout alignment: ensure rows are pinned to the left
                        rows.style.position = 'absolute';
                        rows.style.left = '-3.8em';
                        rows.style.width = '3em';
                    }
                }, 10);
            }
        }

        let currentEditingPath = "";

        /**
         * Open Edit Modal
         * Initializes the modal with current file path and preview content.
         */
        function openEditModal() {
            const pathDisplay = document.getElementById('fileNameDisplay').innerText;
            const path = pathDisplay.replace('üìÑ ', '').trim();
            // Validation: Ensure a file is selected before opening the editor
            if (!path || path === "No file selected") {
                alert("Please select a file from the explorer first.");
                return;
            }

            currentEditingPath = path;
            document.getElementById('modalFileName').innerText = path;

            // Synchronize plain text from preview area to the editor textarea
            const currentCode = document.getElementById('filePreview').textContent;
            document.getElementById('m_content').value = currentCode;

            // Reset state to default: Full Overwrite mode
            document.getElementById('m_full_replace').checked = true;
            toggleEditMode();
            // Show the modal overlay
            document.getElementById('editModal').style.display = 'flex';
        }

        /**
         * Toggle Edit Mode
         * Switches between "Full Overwrite" and "Partial Patch" modes.
         * Adjusts UI accessibility and visual feedback based on the selection.
         */
        function toggleEditMode() {
            const isFull = document.getElementById('m_full_replace').checked;
            const rangeInputs = document.getElementById('rowRangeInputs');
            const contentArea = document.getElementById('m_content');

            if (isFull) {
                // Full Overwrite: Disable line range inputs and add focus styling
                rangeInputs.style.opacity = "0.3";
                rangeInputs.style.pointerEvents = "none";
                contentArea.classList.add('full-replace-active');
            } else {
                // Partial Patch: Enable line range inputs for targeted editing
                rangeInputs.style.opacity = "1";
                rangeInputs.style.pointerEvents = "auto";
                contentArea.classList.remove('full-replace-active');
            }
        }

        /**
         * Close Edit Modal
         * Hides the editor overlay.
         */
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }
        /**
         * Click-outside Detection
         * Closes the modal if the user clicks on the backdrop/overlay area.
         */
        function checkClose(e) {
            // Check if the click target is the modal container itself (the backdrop)
            if (e.target.id === 'editModal') closeEditModal();
        }

        /**
         * Core Save Function
         * Validates edit modes, constructs the task payload, and dispatches the update.
         */
        async function saveQuickEdit() {
            const isFull = document.getElementById('m_full_replace').checked;
            const content = document.getElementById('m_content').value;
            const start = document.getElementById('m_start').value;
            const end = document.getElementById('m_end').value;
            const saveBtn = document.getElementById('saveBtn');

            // Task construction
            const tid = "task_" + Date.now();
            let payload = {
                action: "update_file",
                id: tid,
                file: currentEditingPath,
                content: content
            };

            // Mode determination logic
            if (isFull) {
                payload.range = "0-999999";
            } else {
                if (start && end) {
                    payload.range = `${start}-${end}`;
                } else if (start) {
                    payload.range = `${start}-${start}`;
                } else {
                    // Confirmation to prevent accidental overwrite when line numbers are missing
                    if (!confirm("No line numbers detected. Content will be appended to the end of the file. Proceed?")) return;
                    payload.range = "append";
                }
            }

            // UI Feedback: Set syncing state
            saveBtn.innerText = "üöÄ Syncing with server...";
            saveBtn.disabled = true;

            try {
                const resp = await fetch(`${API_URL}/save_file`, {
                    method: "POST",
                    headers: {
                        "Authorization": "Bearer " + TOKEN,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        type: "command",
                        filename: tid + ".yaml",
                        content: JSON.stringify(payload)
                    })
                });

                if (!resp.ok) throw new Error("Network request failed");

                const result = await poll(tid + ".yaml");
                if (result.success) {
                    alert("‚úÖ File updated successfully!");
                    closeEditModal();
                    
                    if (typeof readFile === "function") readFile(currentEditingPath);
                } else {
                    alert("‚ùå Save failed:" + (result.message || "No error details provided by backend"));
                }
            } catch (e) {
                alert("Operation Exception:" + e.message);
            } finally {
                saveBtn.innerText = "Save & Reload Now";
                saveBtn.disabled = false;
            }
        }
        /**
         * Run Current File
         * Quickly dispatches an execution task for the currently viewed file.
         * Automatically switches to the 'Dispatcher' tab to monitor output.
         */
        async function runCurrentFile() {
            const pathDisplay = document.getElementById('fileNameDisplay').innerText;
            const path = pathDisplay.replace('üìÑ ', '').trim();
            // Validation: Ensure a file is selected from the sidebar
            if (!path || path === "No file selected") {
                return alert("Please select a file from the explorer first.");
            }

            // 1. Auto-switch to 'Dispatcher' (cmd) tab to view the live output
            showTab('cmd');

            const outBox = document.getElementById('cmdResp');
            outBox.innerText = `>> Executing file: ${path} ...\n`;
            outBox.className = "";

            const tid = "task_" + Date.now();

            // --- Backend Mapping: Ensure 'action' matches your server-side router key ---
            const payload = {
                action: "execute",  
                id: tid,
                file: path,    
                args: ""       
            };

            try {
                // Dispatch execution command via a YAML task file
                await fetch(`${API_URL}/save_file`, {
                    method: "POST",
                    headers: { "Authorization": "Bearer " + TOKEN, "Content-Type": "application/json" },
                    body: JSON.stringify({ type: "command", filename: tid + ".yaml", content: JSON.stringify(payload) })
                });
                // Poll for the output result
                const result = await poll(tid + ".yaml");

                // Parse fields: Standardize stdout, stderr, and system messages
                const output = result.content || result;
                outBox.textContent = (output.stdout || "") + (output.stderr || "") + (result.message || "");
                // Visual Feedback: Red text if only stderr is present
                outBox.style.color = (output.stderr && !output.stdout) ? "#ff5555" : "#f8f8f2";
            } catch (e) {
                // Log runtime or network exceptions to the console area
                outBox.innerText += "\nExecution Exception:" + e.message;
            }
        }
    </script>

    <div id="editModal" onclick="if(event.target.id==='editModal')closeEditModal()" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; align-items:center; justify-content:center;">
        <div class="card" style="width:90%; max-width:850px; max-height:95vh; display:flex; flex-direction:column; background:#fff; overflow:hidden; border-radius:8px;">
            <div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; background:#f8f9fa;">
                <h3 style="margin:0; font-size:16px;">üìù EditorÔºö<span id="modalFileName" style="font-size:12px; color:#666;"></span></h3>
                <button class="btn btn-small" onclick="closeEditModal()" style="background:#6c757d;">Close</button>
            </div>
            <div style="padding:15px; display:flex; flex-direction:column; flex:1;">
                <div style="display:flex; align-items:center; gap:15px; margin-bottom:12px; flex-wrap:wrap;">
                    <label style="color:#007bff; font-weight:bold; cursor:pointer; display:flex; align-items:center; font-size:14px;">
                        <input type="checkbox" id="m_full_replace" onchange="toggleEditMode()" style="width:18px; height:18px; margin-right:5px;" checked> Full Overwrite Mode
                    </label>
                    <div id="rowRangeInputs" style="display:flex; align-items:center; gap:5px; font-size:12px;">
                        From:<input id="m_start" type="number" placeholder="1" style="width:50px; padding:4px; border:1px solid #ccc;">
                        To:<input id="m_end" type="number" placeholder="Êú´" style="width:50px; padding:4px; border:1px solid #ccc;">
                    </div>
                    <button class="btn btn-small" onclick="document.getElementById('m_content').value=''" style="background:#dc3545; margin-left:auto;">üóëÔ∏è Clear Canvas</button>
                </div>
                <textarea id="m_content" style="flex:1; min-height:300px; background:#1e1e1e; color:#d4d4d4; padding:12px; font-family:monospace; font-size:14px; line-height:1.5; resize:none; outline:none; border:none; caret-color:white;" spellcheck="false"></textarea>
                <div style="margin-top:15px; display:flex; gap:10px;">
                    <button class="btn" onclick="closeEditModal()" style="flex:1; background:#6c757d;">Cancel</button>
                    <button id="saveBtn" class="btn btn-primary" onclick="saveQuickEdit()" style="flex:2;">Confirm & Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Visual feedback for Full Overwrite Mode */
        .full-replace-active {
            border: 2px solid #007bff !important;
            box-shadow: 0 0 10px rgba(0,123,255,0.3);
        }

        @media (max-width: 768px) {
            #editModal .card {
                width: 100% !important;
                height: 100% !important;
                max-height: 100vh !important;
                border-radius: 0 !important;
            }

            #m_content {
                font-size: 16px !important;
                height: calc(100vh - 220px) !important;
            }
        }
    </style>

</body>
</html>
